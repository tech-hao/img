# x86系统架构概览
## 1.系统级体系结构概览
**系统级架构**包括一组寄存器、数据结构和指令，旨在支持基本的系统级操作，如内存管理、中断和异常处理、任务管理以及多处理器的控制。
下图提供了适用于32位模式的系统寄存器和数据结构的概览。
![IA-32 System-Level Registers and Data Structures](./images/img1.png)
### 1.1 全局描述符表和局部描述符表
  进入保护模式时，所有内存访问都会经过**全局描述符表**(Global Descriptor Table，GDT)或可选的**局部描述符表**(Local Descriptor Table，LDT)。
- **段描述符**
  - 包含于全局描述符表和局部描述符表中
  - 提供段的基址以及访问权限、类型和使用信息
- **段选择器**
  - 每个段描述符都有一个关联的段选择器
  - 段选择器为使用它的软件提供
    - 索引：用于访问`GDT`或`LDT`
    - 全局/局部标志：确定选择器指向`GDT`还是`LDT`
    - 访问权限信息
- 访问段中的一个字节，必须提供一个段选择器和一个偏移量
  - 段选择器提供对段描述符的访问权限
  - 段描述符提供线性地址空间中段的基地址
  - 偏移量提供相对于基地址的字节位置
> `GDT`的基地址的线性地址存储在`GDT`寄存器(`GDTR`)中.
> `LDT`的基地址的线性地址存储在LDT寄存器中(`LDTR`)中.
> 在IA-32e模式下，`GDTR`和`LDTR`寄存器都扩展为64位宽，全局和局部描述符表被扩展以支持64位基址。
### 1.2 系统段、段描述符和门
- **系统段**
  - 任务状态段(`TSS`)
  - `LDT`
> `GDT`不被视为一个段，因为它不是通过段选择器和段描述符来访问的
- **门**
  - 门为系统程序和处理程序提供了受保护的通道，使得程序可以在不同的特权级下运行
  - 通过调用门可以访问于当前代码段相同或较低的特权级的代码段的过程。
    - 调用过程需要提供调用门的选择器
    - 处理器对调用门执行访问权限检查，将CPL与调用门的特权级以及由调用门指向的目标代码段进行比较
    - 如果允许访问目标代码段，处理器将获取目标代码段的段选择器以及从调用门到该代码段的偏移量。
    - 如果调用需要更改特权级，处理器还将切换到所针对特权级别的堆栈。新堆栈的段选择器来自当前运行任务的`TSS`。
> 在IA-32e模式下，调用门便于在64位模式和兼容模式之间进行转换，不支持任务门。在特权级别变化时，堆栈段选择器不是从`TSS`中读取的，而是被设置为`NULL`。
### 1.3 任务状态段和任务门
- **任务状态段(TSS)**
  - `TSS`定义了任务的执行环境状态。它包括：
    - 通用寄存器、段寄存器、`EFLAGS`寄存器、`EIP`寄存器的状态
    - 三个堆栈段的段选择器和堆栈指针的状态
    - 与任务关联的`LDT`的段选择器以及分页结构层次的基址
- 在受保护模式下，所有程序执行都发生在一个任务的上下文中，即当前任务。当前任务的`TSS`的段选择器存储在任务寄存器中。
- 在切换任务时，处理器执行以下操作：
  1. 将当前任务的状态存储在当前`TSS`中。
  2. 使用新任务的段选择器加载任务寄存器
  3. 通过`GDT`中的段描述符访问新`TSS`。
  4. 将新任务的状态从新`TSS`加载到通用寄存器、段寄存器、`LDTR`、控制寄存器`CR3`(分页结构层次的基址)、`EFLAGS`寄存器和`EIP`寄存器中。
  5. 开始执行新任务。
- IA-32e模式不支持硬件任务切换，但`TSS`仍然存在。一个`TSS`的基址由其描述符指定。一个64位`TSS`包含对64位操作重要的以下信息：
  - 每个特权级别的堆栈指针地址
  - 中断堆栈表的指针地址
  - IO权限位图的偏移地址
### 1.4 中断和异常处理
- **中断描述符表**
  - 外部中断、软件中断和异常通过中断描述符表(`IDT`)进行处理。
  - `IDT`存储了一组门描述符，这些描述符提供了访问中断和异常处理程序的方式。
  - `IDT`不是一个段
  - `IDT`的基址的线性地址存储在`IDT`寄存器(`IDTR`)中。
  - `IDT`中的门描述符可以是中断门、陷阱门或任务门描述符
- 异常处理程序的执行
  - 处理器首先从内部硬件、外部中断控制器或通过`INT`、`INTO`、`INT 3`或`BOUND`指令从软件接收一个中断向量。
  - 如果所选的门描述符是中断门或陷阱门，那么与之关联的处理程序将以类似于通过调用门调用过程的方式进行访问。
  - 如果描述符是任务门，那么处理程序将通过任务切换来访问。
> 在IA-32e模式下，中断描述符扩展为16字节以支持64位基址。`IDTR`寄存器被扩展以容纳64位基址。
### 1.5 内存管理
- 系统架构支持直接物理寻址内存或虚拟内存。
  - 当使用物理寻址时，线性地址被视为物理地址。
  - 当使用分页时，所有代码、数据、堆栈和系统段(包括`GDT`和`IDT`)都可以分页，只有最近访问的页面才会保存在物理内存中。
- **分页结构**
  - 分页结构层次的基址物理地址包含在控制寄存器`CR3`中。
  - 分页结构中的条目确定了页面框的基址、访问权限和内存管理信息。
  - 为了使用分页机制，线性地址被分为多个部分，提供对分页结构和页面框的单独偏移。
### 1.6 系统寄存器
  为了协助初始化处理器并控制系统操作，系统架构提供了`EFLAGS`寄存器中的系统标志和几个系统寄存器：
  - **控制寄存器**(`CR0`、`CR2`、`CR3`和`CR4`)包含了各种用于控制系统级操作的标志和数据字段。这些寄存器中的其他标志用于指示在操作系统或执行程序中支持特定处理器功能。
  - **调试寄存器**允许设置断点，用于调试程序和系统软件。
  - **`GDTR`、`LDTR`和`IDTR`寄存器**包含其各自表格的线性地址和大小。
  - **任务寄存器**包含当前任务的`TSS`的线性地址和大小.
  - **特定于型号的寄存器(`MSR`)**
    - `MSR`是一组主要提供给操作系统或执行程序过程(即特权级别0下运行的代码)的寄存器。

> 大多数系统限制应用程序对系统寄存器的访问。但通过设计系统，使其中所有程序和过程都在最高特权级别下运行，此时应用程序将被允许修改系统寄存器。
## 2.实模式和保护模式转换
**保护模式**是处理器的本机操作模式。它提供了丰富的体系结构特性、灵活性、高性能以及向现有软件基础的向后兼容性。
**实模式**提供了类似于Intel 8086处理器的编程环境，带有一些扩展功能，如切换到保护模式或系统管理模式的能力。
在硬件或软件复位后要在保护模式下使用处理器，必须从实地址模式执行模式切换。一旦进入保护模式，通常软件不需要返回到实地址模式。
### 2.1 切换到保护模式
在从实模式切换到保护模式之前，必须将一组最小的系统数据结构和代码模块加载到内存中。一旦创建了这些表格，软件初始化代码就可以切换到保护模式。
通过执行`MOV CR0`指令来进入保护模式，该指令设置了`CR0`寄存器中的 `PE` 标志。在保护模式中执行时，CPL为 0。
切换到保护模式需要按照以下步骤进行操作：
  1. 屏蔽中断。`CLI` 指令可以禁用可屏蔽的硬件中断。`NMI` 中断可以通过外部电路禁用。
  2. 执行 `LGDT` 指令，将 `GDTR` 寄存器加载为 `GDT` 的基地址。
  3. 执行 `MOV CR0` 指令，设置控制寄存器 `CR0` 中的 `PE` 标志以及可选的 `PG` 标志。
  4. 执行远跳转（`far JMP`）或远调用（`far CALL`）指令。 
  5. 如果启用了分页，那么用于 `MOV CR0` 指令和 `JMP` 或 `CALL` 指令的代码必须来自一个恒等映射的页面。
  6. 如果将使用本地描述符表（`LDT`），则执行 `LLDT` 指令，将 `LDT` 的段选择器加载到 `LDTR` 寄存器中。
  7. 执行 `LTR` 指令，使用段选择器加载任务寄存器`TR`，以便切换到初始的保护模式任务或用于在任务切换时存储 `TSS` 信息的可写内存区域。
  8. 进入保护模式后，段寄存器继续保存它们在实地址模式下的内容。步骤 4 中的 `JMP` 或 `CALL` 指令会重置 `CS` 寄存器。执行以下操作之一以更新其余段寄存器的内容:
     - 重新加载段寄存器 `DS`、`SS`、`ES`、`FS` 和 `GS`。
     - 执行 `JMP` 或 `CALL` 指令切换到新任务，这会自动重置段寄存器的值并跳转到新的代码段。

  9.  执行 `LIDT` 指令，将 `IDTR` 寄存器加载为保护模式 `IDT` 的地址和限制。
  10. 执行 `STI` 指令以开中断，并执行必要的硬件操作以启用 `NMI` 中断
### 2.2 切换到实模式
如果软件使用 `MOV CR0` 指令清除 `CR0` 寄存器中的 `PE` 位，处理器将从保护模式切换回实地址模式。
重新进入实地址模式的过程应执行以下步骤：
  1. 屏蔽中断。`CLI` 指令可以禁用可屏蔽的硬件中断。`NMI` 中断可以通过外部电路禁用。
  2. 如果启用了分页，执行以下操作：
     - 将程序控制权转移到线性地址，这些线性地址与物理地址恒等映射（即，线性地址等于物理地址）。
     - 确保 `GDT` 和 `IDT` 位于恒等映射页面中。
     - 清除 `CR0` 寄存器中的 `PG` 位。
     - 将 `0H` 移入 `CR3` 寄存器以刷新 `TLB`。
  3. 将程序控制权转移到一个可读的段，其限制为 64K 字节（FFFFH）。这个操作会将 `CS` 寄存器加载为实地址模式所需的段限制。
  4. 使用描述符选择器加载段寄存器 `SS`、`DS`、`ES`、`FS` 和 `GS` 。
  5. 执行 `LIDT` 指令，指向一个位于 1MB 实地址模式地址范围内的实地址模式中断表。
  6. 清除 `CR0` 寄存器中的 `PE` 标志以切换到实地址模式。
  7. 执行一条 `far JMP` 指令，跳转到一个实地址模式程序。这个操作会刷新指令队列并加载 `CS` 寄存器中适当的基址值。
  8. 根据实地址模式代码的需要加载 `SS`、`DS`、`ES`、`FS` 和 `GS` 寄存器。如果其中任何寄存器在实地址模式下不会被使用，可以将它们写为 0。
  9.  执行 `STI` 指令以关中断，并执行必要的硬件操作以启用`NMI`中断。
## 3.80x86系统指令寄存器
### 3.1 标志寄存器 `EFLAGS`
`EFLAGS`寄存器中的系统标志和`IOPL`字段控制I/O、可屏蔽硬件中断、调试、任务切换以及虚拟-8086模式,如下图所示。
![system-flags-in-the-EFLAGS-reg](./images/system_flags_in_the_EFLAGS_register.png)
其中的系统标志和`IOPL`字段包括：
- **TF(Trap)**：
  - 设置以启用调试的单步模式
  - 清除以禁用单步模式。
- **IF(Interrupt enable)**：
  - 功能：控制处理器对可屏蔽硬件中断请求的响应。
  - 当设置时，`IF`用于响应可屏蔽硬件中断。
  - 当清除时，`IF`用于禁止可屏蔽硬件中断。
- **IOPL(I/O privilege level field)**：
  - 功能：指示当前运行的程序或任务的I/O特权级别(`IOPL`)。
  - 当前运行的程序或任务的CPL必须小于或等于`IOPL`才能访问I/O地址空间。只有在CPL为0时，`POPF`和`IRET`指令才能修改此字段。
- **NT(Nested task)**：
  - 功能：控制被中断和被调用任务的链接。
  - 处理器在使用`CALL`指令、中断或异常启动的任务调用时设置此标志。
  - 在从使用`IRET`指令启动的任务返回时，处理器会检查和修改此标志。
  - 可以使用`POPF`/`POPFD`指令显式地设置或清除此标志；但是，更改此标志的状态可能会在应用程序中产生意外的异常。
- **RF(Resume)**：
  - 功能：控制处理器对指令断点条件的响应。
  - 当设置时，此标志会临时禁用由于指令断点而产生的调试异常。
  - 当清除时，指令断点将会产生调试异常。
- **VM(Virtual-8086 mode)**：
  - 设置以启用虚拟-8086模式
  - 清除以返回到保护模式。
- **AC(Alignment check)**：
  - 设置此标志和控制寄存器`CR0`中的`AM`标志以启用内存引用的对齐检查，
  - 清除`AC`标志和/或`AM`标志以禁用对齐检查。
- **VIF(Virtual Interrupt)**：
  - 此标志与`VIP`标志一起使用。
  - 只有当控制寄存器`CR4`中的`VME`标志或`PVI`标志被设置且`IOPL`小于3时，处理器才会识别`VIF`标志。
- **VIP(Virtual interrupt pending)**：
  - 设置以指示存在未决中断
  - 清除以表示没有未决中断。
  - 处理器会读取此标志但从不修改它。
  - 只有当控制寄存器`CR4`中的`VME`标志或`PVI`标志被设置，且`IOPL`小于3时，处理器才会识别`VIP`标志。
- **ID(Identification)**：
  - 程序或过程能够设置或清除此标志的能力表示对CPUID指令的支持。
### 3.2 内存管理寄存器
  处理器提供了四个内存管理寄存器——`GDTR`、`LDTR`、`IDTR` 和 `TR`，用于指定控制分段内存管理的数据结构的位置，如下图所示。提供特殊指令来加载和存储这些寄存器。
  ![memory-management-registers](./images/memory-management-registers.png)
- **全局描述符表寄存器(GDTR)**
  - `GDTR`寄存器保存了GDT的基地址和16位的表限制。
    - 基地址指定了GDT的第0字节的线性地址，在保护模式下为32位；在IA-32e模式下为64位。
    - 表限制指定了表中的字节数。
  - `LGDT`和`SGDT`指令分别用于加载和存储`GDTR`寄存器。
  - 在处理器上电或复位时，基地址被设置为默认值0，限制被设置为0FFFFH。在保护模式操作的处理器初始化过程中，必须加载新的基地址到`GDTR`寄存器中。
- **局部描述符表寄存器(LDTR)**
  - `LDTR`寄存器保存了16位段选择器、基地址、段限制和LDT的描述符属性。
    - 基地址指定了LDT段的第0字节的线性地址，在保护模式下为32位；在IA-32e模式下为64位。
    - 段限制指定了段中的字节数。
  - `LLDT`和`SLDT`指令分别用于加载和存储`LDTR`寄存器的段选择器部分。包含`LDT`的段必须在`GDT`中具有一个段描述符。
  - 当`LLDT`指令加载`LDTR`中的段选择器时，`LDTR`会自动加载LDT描述符中的基地址、限制和描述符属性。
  - 发生任务切换时，`LDTR`会自动加载新任务的`LDT`的段选择器和描述符。`LDTR`的内容不会在写入新的`LDT`信息之前自动保存。
  - 在处理器上电或复位时，段选择器和基地址被设置为默认值0，限制被设置为`0FFFFH`。
- **中断描述符表寄存器(IDTR)**
  - `IDTR`寄存器保存了中断描述符表(`IDT`)的基地址和16位的表限制。
    - 基地址指定了`IDT`的第0字节的线性地址，在保护模式下为32位；在IA-32e模式下为64位。
    - 表限制指定了表中的字节数。
  - `LIDT`和`SIDT`指令分别用于加载和存储`IDTR`寄存器。
  - 在处理器上电或复位时，基地址被设置为默认值0，限制被设置为`0FFFFH`。寄存器中的基地址和限制可以作为处理器初始化过程的一部分进行更改。
- **任务寄存器(TR)**
  - 任务寄存器保存了当前任务的`TSS`(任务状态段)的16位段选择器、基地址、段限制和描述符属性。 
    - 选择器引用了`GDT`中的`TSS`描述符。
    - 基地址指定了`TSS的`第0字节的线性地址，在保护模式下为32位；在IA-32e模式下为64位。
    - 段限制指定了`TSS`中的字节数。
  - `LTR`和`STR`指令分别用于加载和存储任务寄存器的段选择器部分。
  - 当`LTR`指令加载任务寄存器中的段选择器时，`TSS`描述符中的基地址、限制和描述符属性会自动加载到任务寄存器中。
  - 在处理器上电或复位时，基地址被设置为默认值0，限制被设置为`0FFFFH`。
  - 发生任务切换时，任务寄存器会自动加载新任务的`TSS`的段选择器和描述符。任务寄存器的内容不会在写入新的`TSS`信息之前自动保存。
### 3.3 控制寄存器
  **控制寄存器**确定处理器的操作模式和当前正在执行任务的特性。
  控制寄存器概述如下
  - `CR0 `——包含控制处理器的操作模式和状态的系统控制标志。
  - `CR1` ——保留
  - `CR2` ——包含引发页故障的线性地址（引发页故障的线性地址）。
  - `CR3` ——包含分页结构层次的基础物理地址和两个标志——PCD和PWT。
    - PCD和PWT标志控制处理器内部数据缓存中的分页结构的缓存，它们不控制页目录信息的TLB缓存。
![control-registers](./images/control_registers.png)

控制寄存器中的标志包括：
- **PG（Paging）——CR0的第31位**
  - 当设置时启用分页。
  - 当清除时禁用分页。
    - 当禁用分页时，所有线性地址都被视为物理地址。
  - 如果`PE`标志未设置，则`PG`标志无效。在`PE`标志未设置的情况下设置`PG`标志会引发通用保护异常。
- **CD（Cache Disable）——CR0的第30位**
  - 当`CD`和`NW`标志都清除时，启用处理器的内部（和外部）缓存对整个物理内存的内存位置的缓存。
  - 要防止处理器访问和更新其缓存，必须设置`CD`标志并使缓存无效，以确保不会发生缓存命中。
- **NW（Not Write-through）——CR0的第29位**
  - 当`NW`和`CD`标志都清除时，对于命中缓存的写入启用写回或写直达。
    - 奔腾4、Intel Xeon、P6家族和奔腾处理器等采用写回方式
    - Intel486处理器采用写直达方式
- **AM（Alignment Mask）——CR0的第18位**
  - 当设置时启用自动对齐检查
  - 当清除时禁用对齐检查。
- **WP（Write Protect）——CR0的第16位**
  - 当设置时，禁止监管级别的程序写入只读页。
  - 当清除时，允许监管级别的程序写入只读页，无论U/S位的设置如何。
  - `WP`标志有助于实现诸如UNIX等操作系统使用的创建新进程的写时复制方法的实施。
- **NE（Numeric Error）——CR0的第5位**
  - 当设置时启用用于报告x87 FPU错误的本机（内部）机制。
  - 当清除时启用PC风格的x87 FPU错误报告机制。
- **ET（Extension Type）——CR0的第4位**
  - `ET`标志在奔腾4、Intel Xeon、P6家族和奔腾处理器中保留，被硬编码为1。
  - 在Intel386和Intel486处理器中，此标志表示支持Intel 387 DX数学协处理器指令。
- **TS（Task Switched）——CR0的第3位**
  - 处理器在每次任务切换时设置此标志，并在执行x87 `FPU`/`MMX`/`SSE`/`SSE2`/`SSE3`/`SSSE3`/`SSE4`指令时测试它。
- **EM（Emulation）——CR0的第2位**
  - 当设置时，指示处理器没有内部或外部x87 FPU。
  - 当清除时，表示存在x87 FPU。
  - 此标志还影响对`MMX`/`SSE`/`SSE2`/`SSE3`/`SSSE3`/`SSE4`指令的执行。
    - 当设置`EM`标志时，执行x87 FPU指令会生成设备不可用异常（#NM）。
    - 当处理器没有内部x87 FPU或未连接到外部数学协处理器时，必须设置此标志。设置此标志会强制所有浮点指令由软件模拟处理。
  - 当设置`EM`标志时，执行MMX指令会导致生成无效操作码异常（#UD）。
- **MP（Monitor Coprocessor）——CR0的第1位**
  - 控制`WAIT`或`FWAIT`指令与`TS`标志的交互。
  - 如果设置了`MP`标志，当`TS`标志也被设置时，`WAIT`指令会生成设备不可用异常（#NM）。
  - 如果清除`MP`标志，`WAIT`指令将忽略`TS`标志的设置。
- **PE（Protection Enable）——CR0的第0位**
  - 当设置时启用保护模式。
  - 当清除时启用实地址模式。
  - 此标志不直接启用分页。它只启用段级别的保护。要启用分页，必须同时设置`PE`和`PG`标志。
- **PCD（Page-level Cache Disable）——CR3的第4位**
  - 控制用于访问当前分页结构层次结构的第一个分页结构的内存类型。
  - 如果禁用分页，使用PAE分页，或者使用CR4.PCIDE=1的IA-32e分页，则不使用此位。
- **PWT（Page-level Write-Through）——CR3的第3位**
  -  控制用于访问当前分页结构层次结构的第一个分页结构的内存类型。请参
  -  如果禁用分页，使用PAE分页，或者使用CR4.PCIDE=1的IA-32e分页，则不使用此位。
## 4.系统指令
系统指令用于处理系统级功能，例如加载系统寄存器、管理缓存、管理中断或设置调试寄存器。这些指令中的许多只能由操作系统或执行程序执行,其他一些可以在任何特权级别下执行，因此可供应用程序使用。
- `LGDT`（Load GDTR Register）
  - 从内存中加载 GDT 基地址和限制到 `GDTR` 寄存器。
- `SGDT`（Store GDTR Register）
  - 将 GDTR 寄存器中的 GDT 基地址和限制存储到内存中。
- `LIDT`（Load IDTR Register）
  - 从内存中加载 IDT 基地址和限制到 `IDTR` 寄存器。
- `SIDT`（Load IDTR Register）
  - 将 IDTR 寄存器中的 IDT 基地址和限制存储到内存中。
- `LLDT`（Load LDT Register）
  - 从内存中加载 `LDT` 段选择符和段描述符到 `LDTR` 寄存器。（段选择符操作数也可以位于通用寄存器中。）
- `SLDT`（Store LDT Register）
  - 将 LDTR 寄存器中的 `LDT` 段选择符存储到内存或通用寄存器中。
- `LTR`（Load Task Register）
  - 从内存中加载用于 `TSS` 的段选择符和段描述符到任务寄存器。（段选择符操作数也可以位于通用寄存器中。）
- `STR`（Store Task Register）
  - 将当前任务 `TSS` 的段选择符从任务寄存器存储到内存或通用寄存器中。
